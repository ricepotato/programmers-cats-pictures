<html>
  <head>
    <title>고양이 사진첩!</title>
    <link rel="stylesheet" href="./src/styles/style.css">
  </head>
  <script src="js/api.js"></script>
  <body>
    <h1>고양이 사진첩</h1>
    <main class="App">
      <nav id="breadcrumb" class="Breadcrumb">
        <div>root</div>
        <div>노란고양이</div>
      </nav>
      <div id="nodes" class="Nodes">
        
      </div>
      <!--<div>
        <div class="Node">
          <img src="./assets/prev.png">
        </div>
        <div class="Node">
          <img src="./assets/directory.png">
          <div>2021/04</div>
        </div>
        <div class="Node">
          <img src="./assets/file.png">
          <div>하품하는 사진</div>
        </div>-->
      </div>
    </main>
    <!-- Loading Layer sample markup -->
    
    <div id="modalLoading" style="display:none;" class="Modal Loading">
      <div class="content">
        <img style="width:100%;" src="./assets/nyan-cat.gif">
      </div>
    </div>
    

    <!-- ImageViewer sample markup -->
    <div id="modalViewer" style="display:none;" class="Modal ImageViewer">
      <div class="content">
        <img id="modalImage" style="width:100%;" src="./assets/sample_image.jpg">
    </div>
  <script>
    class Directory{
      constructor(){
        this.path = [];
        this.prev = null;
        this.api = new CatsApi();
      }

      isLoading(loading){
        if(loading){
          document.getElementById("modalLoading").style.display = "block";
        }else{
          document.getElementById("modalLoading").style.display = "none";
        }
        
      }

      goRoot(){
        this.path = [{name:"root", id:null}];
        this.isLoading(true);
        this.api.getCats((data) => this.update(data));
      }

      toDir(item){
        this.path.push({name:item.name, id:item.id});
        this.isLoading(true);
        this.api.getCatById(item.id, (data) => this.update(data));
      }

      toPrev(){
        const last = this.path.pop();
        const prev = this.path.pop();
        if(prev.name === "root"){
          this.goRoot();
        }else{
          this.toDir(prev);
        }
      }

      showImage(src){
        const modal = document.getElementById("modalViewer");
        modal.style.display = "block";
        const modalImage = document.getElementById("modalImage");
        modalImage.src = src;
      }

      update(data){
        const nodes = document.getElementById("nodes");
        const breadcrumb = document.getElementById("breadcrumb");
        this.isLoading(false);
        breadcrumb.innerHTML = "";
        this.path.map((item) => {
          const elem = document.createElement("div");
          elem.innerText = item.name;
          breadcrumb.appendChild(elem);
        });
        
        nodes.innerHTML = "";
        if(this.path.length > 1){
          nodes.appendChild(this.getPrevNodeItem(this.path[this.path.length - 2]));
        }

        data.forEach(item => {
          if(item.type === "DIRECTORY"){
            nodes.appendChild(this.getDirectoryComponent(item));
          }else if(item.type === "FILE"){
            nodes.appendChild(this.getFileNodeItem(item));
          }
        });
      }

      getDirectoryComponent(item){
        const node = document.createElement("div");
        const img = document.createElement("img");
        const name = document.createElement("div");
        node.className = "Node";

        img.dataset.id = item.id;
        img.dataset.name = item.name;
        img.src = "./assets/directory.png";
        img.addEventListener("click", (e) => this.toDir(item));

        name.innerText = item.name
        node.appendChild(img);
        node.appendChild(name);
        return node;
      }

      getPrevNodeItem(item){
        const node = document.createElement("div");
        node.className = "Node";
        const img = document.createElement("img");
        img.src = "./assets/prev.png";
        node.appendChild(img);
        img.addEventListener("click", () => this.toPrev());
        return node;
      }

      getFileNodeItem(item){
        const node = document.createElement("div");
        node.className = "Node";
        const img = document.createElement("img");
        img.src = `https://fe-dev-matching-2021-03-serverlessdeploymentbuck-t3kpj3way537.s3.ap-northeast-2.amazonaws.com/public${item.filePath}`;
        node.appendChild(img);
        img.addEventListener("click", () => this.showImage(img.src));
        return node;
      }
    }
    
    function init(){
      const modalImage = document.getElementById("modalImage");
      modalImage.addEventListener("click", (e) => {
        e.stopPropagation();
        e.preventDefault();
      })
      const modalViewer = document.getElementById("modalViewer");
      modalViewer.addEventListener("click", (e) => {
        e.stopPropagation();
        e.target.style.display = "none"
      });
      const directory = new Directory();
      directory.goRoot();
    }
    init();
  </script>
  </body>
</html>